---
up: [[SQL]]
---
# Запросы
### Виды Join’ов?
JOIN - оператор языка SQL, который является реализацией операции соединения реляционной алгебры.  
Предназначен для обеспечения выборки данных из двух таблиц и включения этих данных в один результирующий набор.
Особенностями операции соединения являются следующее:  
* в схему таблицы-результата входят столбцы обеих исходных таблиц (таблиц-операндов), то есть схема результата является «сцеплением» схем операндов;  
* каждая строка таблицы-результата является «сцеплением» строки из одной таблицы-операнда со  строкой второй таблицы-операнда;  
* при необходимости соединения не двух, а нескольких таблиц, операция соединения применяется  несколько раз (последовательно).
Какие существуют типы JOIN?  
* **(INNER) JOIN** Результатом объединения таблиц являются записи, общие для левой и правой таблиц.  Порядок таблиц для оператора не важен, поскольку оператор является симметричным.  
 * **LEFT (OUTER) JOIN** Кортежи из внутреннего соединения, и не вошедшие во внутреннее соединение  кортежи из левого источника. Атрибуты в кортежах, которые не имеют совпадений по общим столбцам заполняются неопределенными значениями. Порядок таблиц для оператора важен, поскольку оператор не является симметричным.  
 * **RIGHT (OUTER) JOIN**
 * **FULL (OUTER) JOIN** Результатом объединения таблиц являются все записи, которые присутствуют в таблицах. Порядок таблиц для оператора не важен, поскольку оператор является симметричным.
 * **CROSS JOIN** (декартово произведение)  
```sql
SELECT *  
FROM actor  
NATURAL JOIN film_actor  
NATURAL JOIN film  
```
Обратите внимание, в этом запросе нет необходимости указывать какие-либо критерии объединения, поскольку предложение NATURAL JOIN автоматически определяет столбцы, имеющие одинаковые имена в обеих объединяемых таблицах, и помещает их в «скрытое» предложение USING. Если первичные и внешние ключи имеют одинаковые имена, этот подход может показаться полезным, однако это не так.

### Что лучше использовать join или подзапросы? Почему?
Обычно лучше использовать JOIN, поскольку в большинстве случаев он более понятен и лучше оптимизируется СУБД (но 100% этого гарантировать нельзя). Так же JOIN имеет заметное преимущество над подзапросами в случае, когда список выбора SELECT содержит столбцы более чем из одной таблицы.  
Подзапросы лучше использовать в случаях, когда нужно вычислять агрегатные 
значения и использовать их для сравнений во внешних запросах.

### Что делает UNION?
В языке SQL ключевое слово **UNION применяется для объединения результатов двух SQL-запросов в единую таблицу**, состоящую из схожих записей. Оба запроса должны возвращать одинаковое число столбцов и совместимые типы данных в соответствующих столбцах. Необходимо отметить, что UNION сам по себе не гарантирует порядок записей. Записи из второго запроса могут оказаться в начале, в конце или вообще перемешаться с записями из первого запроса. В случаях, когда требуется определенный порядок, необходимо использовать ORDER BY.  
Разница между UNION и UNION ALL заключается в том, что UNION будет пропускать дубликаты записей, тогда как UNION ALL будет включать дубликаты записей.

### Чем WHERE отличается от HAVING?
**WHERE нельзя использовать с агрегатными функциями, HAVING можно (предикаты тоже).**  
В HAVING можно использовать псевдонимы только если они используются для наименования результата агрегатной функции, в WHERE можно всегда.  
HAVING стоит после GROUP BY, но может использоваться и без него. При отсутствии предложения GROUP BY агрегатные функции применяются ко всему выходному набору строк запроса, т.е. в результате мы получим всего одну строку, если выходной набор не пуст.

### Что такое ORDER BY?
**ORDER BY упорядочивает вывод запроса согласно значениям в том или ином количестве выбранных столбцов**. Многочисленные столбцы упорядочиваются один внутри другого. Возможно определять возрастание ASC или убывание DESC для каждого столбца. По умолчанию установлено - возрастание.

### Что такое DISTINCT?
DISTINCT указывает, что для вычислений используются только уникальные значения столбца.

### Что такое GROUP BY?
GROUP BY используется для агрегации записей результата по заданным атрибутам.  
Cоздает отдельную группу для всех возможных значений (включая значение NULL)  
При использовании GROUP BY все значения NULL считаются равными.

### Что такое LIMIT?
Ограничивает выборку заданным числом.

### Что такое EXISTS?
EXISTS берет подзапрос, как аргумент, и оценивает его как TRUE, если подзапрос возвращает какие-либо записи и FALSE, если нет.

### Расскажите про операторы IN, BETWEEN, LIKE
* IN - определяет набор значений.  
SELECT * FROM Persons WHERE name IN ('Ivan','Petr','Pavel');  
* BETWEEN определяет диапазон значений. В отличие от IN, BETWEEN чувствителен к порядку, и первое значение в предложении должно быть первым по алфавитному или числовому порядку.  
```sql
SELECT * FROM Persons WHERE age BETWEEN 20 AND 25;  
```
* LIKE применим только к полям типа CHAR или VARCHAR, с которыми он используется чтобы находить подстроки. В качестве условия используются символы шаблонизации (wildkards) - специальные символы, которые могут соответствовать чему-нибудь:  
   * _ замещает любой одиночный символ. Например, 'b_t' будет соответствовать словам 'bat' или 'bit', но не будет соответствовать 'brat'.  
    * % замещает последовательность любого числа символов. Например '%p%t' будет соответствовать словам 'put', 'posit', или 'opt', но не 'spite'.  
```sql
SELECT * FROM UNIVERSITY WHERE NAME LIKE '%o';
```

### Как сделать запрос из двух баз?
Если в запросе таблица указывается с именем базы данных database1.table1, то таблица выбирается из database1, если просто table1, то - из активной базы данных.  
Надо, чтобы базы были на одном сервере.  
```sql
SELECT t1.*, t2.*  
FROM database1.table1 AS t1  
INNER JOIN database2.table2 AS t2 ON t1.field1 = t2.field1
```

### Что быстрее убирает дубликаты distinct или group by?
* Если нужны уникальные значения - DISTINCT.  
* Если нужно группировать значения - GROUP BY.    

Если задача заключается именно в поиске дубликатов - GROUP BY будет лучше.

### Механизмы оптимизации запросов в БД
Например, добавить индекс по нужной колонке.